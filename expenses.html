<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OnlyBackpackers - Registro de Gastos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="expenses.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const menuToggle = document.getElementById("menu-toggle");
      const menu = document.getElementById("menu");
      menuToggle?.addEventListener("click", () => {
        menu.classList.toggle("active");
      });

      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          tabButtons.forEach(b => b.classList.remove("active"));
          tabContents.forEach(c => c.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add("active");
        });
      });

      // Cargar monedas en el conversor
      async function cargarMonedas() {
        try {
          const res = await fetch('https://api.exchangerate.host/symbols');
          const data = await res.json();
          const symbols = data.symbols;
          const fromSelect = document.getElementById("from-currency");
          const toSelect = document.getElementById("to-currency");

          for (let code in symbols) {
            const optionFrom = document.createElement("option");
            optionFrom.value = code;
            optionFrom.textContent = `${code} - ${symbols[code].description}`;
            fromSelect.appendChild(optionFrom);

            const optionTo = document.createElement("option");
            optionTo.value = code;
            optionTo.textContent = `${code} - ${symbols[code].description}`;
            toSelect.appendChild(optionTo);
          }
        } catch (err) {
          console.error("Error cargando monedas", err);
        }
      }
      cargarMonedas();

      // Conversor de moneda
      const currencyForm = document.getElementById("currency-form");
      const conversionResult = document.getElementById("conversion-result");
      currencyForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById("convert-amount").value);
        const from = document.getElementById("from-currency").value;
        const to = document.getElementById("to-currency").value;

        if (isNaN(amount) || !from || !to) {
          conversionResult.textContent = "Por favor, completa todos los campos correctamente.";
          return;
        }

        try {
          const res = await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`);
          const data = await res.json();
          conversionResult.textContent = `${amount} ${from} = ${data.result.toFixed(2)} ${to}`;
        } catch (err) {
          console.error("Error en la conversión", err);
          conversionResult.textContent = "Error al convertir moneda.";
        }
      });

      // Gastos personales
      const expenseForm = document.getElementById("expense-form");
      const expenseList = document.getElementById("expense-list");
      const totalExpenses = document.getElementById("total-expenses");
      const ctx = document.getElementById("expense-chart-canvas")?.getContext("2d");

      let expenses = [];
      const categories = ["transporte", "comidas", "alojamiento", "actividades", "otros"];
      const chartData = {
        labels: ["Transporte", "Comidas", "Alojamiento", "Actividades", "Otros"],
        datasets: [{ data: [0, 0, 0, 0, 0], backgroundColor: ["#0077cc", "#ff6600", "#00bfff", "#66cc66", "#cccccc"] }]
      };

      let expenseChart = null;
      if (ctx) {
        expenseChart = new Chart(ctx, { type: "pie", data: chartData, options: { responsive: true } });
      }

      const updateChart = () => {
        if (!expenseChart) return;
        const totals = categories.map(cat => expenses.filter(exp => exp.category === cat).reduce((sum, exp) => sum + exp.amount, 0));
        expenseChart.data.datasets[0].data = totals;
        expenseChart.update();
      };

      expenseForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("expense-name").value.trim();
        const category = document.getElementById("expense-category").value;
        const amount = parseFloat(document.getElementById("expense-amount").value);
        const currency = document.getElementById("expense-currency").value.trim();
        const notes = document.getElementById("expense-notes").value.trim();

        if (name && category && !isNaN(amount) && currency) {
          const expense = { name, category, amount, currency, notes };
          expenses.push(expense);

          const li = document.createElement("li");
          li.innerHTML = `<strong>${name}</strong> - ${amount} ${currency} (${category})<br>${notes}`;
          expenseList.appendChild(li);

          const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
          totalExpenses.textContent = `Total: ${total.toFixed(2)} €`;

          updateChart();
          expenseForm.reset();
        }
      });

      // Gastos grupales
      const groupForm = document.getElementById("group-expense-form");
      const groupList = document.getElementById("group-expense-list");
      const groupTotal = document.getElementById("group-total");

      groupForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("group-name").value.trim();
        const amount = parseFloat(document.getElementById("group-amount").value);
        const members = document.getElementById("group-members").value.split(",").map(m => m.trim()).filter(m => m);

        if (name && !isNaN(amount) && members.length > 0) {
          const share = (amount / members.length).toFixed(2);
          members.forEach(member => {
            const li = document.createElement("li");
            li.innerText = `${member} debe pagar ${share} € por ${name}`;
            groupList.appendChild(li);
          });

          groupTotal.textContent = `Total grupal: ${amount.toFixed(2)} €`;
          groupForm.reset();
        }
      });
    });
  </script>
</head>
<body>
